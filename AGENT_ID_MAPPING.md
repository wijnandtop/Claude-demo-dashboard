# Agent ID Mapping Flow

## The Problem: Two Different IDs

When Claude spawns a subagent via the Task tool, there are TWO different identifiers:

### 1. Tool Use ID (Long Format)
```
toolu_015z58Lyxh7u3usBwtftsfxB
```
- Generated by Claude API
- Used in the orchestrator's session file
- Used as the key in `agentsMap`

### 2. Agent ID (Short Hash)
```
abe13d7
```
- Generated by Claude Code CLI
- Used in agent file naming: `agent-abe13d7.jsonl`
- Stored in each line of the agent file as `agentId` field

## The Data Flow

```
ORCHESTRATOR SESSION FILE (session-id.jsonl)
└─> Task tool_use event
    ├─> type: "assistant"
    ├─> content[].type: "tool_use"
    ├─> content[].name: "Task"
    └─> content[].id: "toolu_015z58Lyxh7u3usBwtftsfxB"  ← Tool Use ID

        ↓ (Task launches async agent)

└─> Task tool_result event
    ├─> type: "user"
    ├─> message.content[].type: "tool_result"
    ├─> message.content[].tool_use_id: "toolu_015z58Lyxh7u3usBwtftsfxB"  ← Links back to Task
    └─> toolUseResult.agentId: "abe13d7"  ← **THE MAPPING!** Agent file ID

AGENT FILE (agent-abe13d7.jsonl)
├─> filename contains: "abe13d7"
└─> each line contains: { "agentId": "abe13d7", ... }
```

## The Fix: Two-Step Mapping

### Step 1: Build the mapping table
When processing tool_result events, extract and store both IDs:

```javascript
agentsMap = {
  "toolu_015z58Lyxh7u3usBwtftsfxB": {
    id: "toolu_015z58Lyxh7u3usBwtftsfxB",    // Tool Use ID (key)
    realAgentId: "abe13d7",                  // Agent file ID (NEW!)
    actions: [],
    messages: []
  }
}
```

### Step 2: Match agent files using realAgentId
When processing agent files, search for the agent with matching `realAgentId`:

```javascript
// Agent file has: agentId = "abe13d7"
for (const [toolUseId, agent] of agentsMap.entries()) {
  if (agent.realAgentId === "abe13d7") {  // ✓ MATCH!
    agent.actions = agentFileData.actions;
    agent.messages = agentFileData.messages;
  }
}
```

## Why This Was Broken

The original code tried to match directly:
```javascript
// ✗ BROKEN: Looking for "abe13d7" in map keyed by "toolu_015z58Lyxh7u3usBwtftsfxB"
const agent = agentsMap.get("abe13d7");  // Always returns undefined!
```

## Example Mapping Table

| Tool Use ID (Map Key) | Real Agent ID | Agent File |
|----------------------|---------------|------------|
| toolu_015z58Lyxh7u3usBwtftsfxB | abe13d7 | agent-abe13d7.jsonl |
| toolu_01RNGh9XWzXjKzw1ZF7dXTHg | ab1e5f7 | agent-ab1e5f7.jsonl |
| toolu_01N3WZgv6VQj7TU3p7eMVfSo | acd61d4 | agent-acd61d4.jsonl |
