# Debug Report: Subagent Activities Not Showing in Dashboard

## Problem
When the dashboard parses sessions, subagent messages and actions aren't appearing in the UI.

## Root Cause Analysis

### The ID Mismatch
The issue was caused by a mismatch between two different agent identifiers:

1. **Task tool_use ID** (stored in agentsMap): `toolu_015z58Lyxh7u3usBwtftsfxB`
   - This is the tool_use block's `id` field
   - Generated by Claude when creating a Task tool call
   - Stored as the key in `agentsMap`

2. **Agent file ID** (in agent-*.jsonl filename): `abe13d7`
   - This is a short hash used in the agent file naming: `agent-abe13d7.jsonl`
   - Also stored in each line of the agent file as `agentId` field
   - Returned in the `toolUseResult.agentId` field when the Task launches

### The Broken Matching Logic

**Before the fix:**
```javascript
// Line 175: Store tool_use ID as the agent key
const agentId = block.id;  // e.g., "toolu_015z58Lyxh7u3usBwtftsfxB"
agentsMap.set(agentId, { ... });

// Line 297-298: Try to match agent file's agentId directly
const agent = agentsMap.get(agentData.agentId);  // agentData.agentId = "abe13d7"
```

This would NEVER match because:
- Map key = `toolu_015z58Lyxh7u3usBwtftsfxB`
- Looking for = `abe13d7`

### The Solution

The key insight is that the `toolUseResult` object in the tool_result event contains the mapping:

```json
{
  "type": "user",
  "toolUseResult": {
    "agentId": "abe13d7",  // <-- This is the real agent file ID!
    ...
  },
  "message": {
    "content": [{
      "type": "tool_result",
      "tool_use_id": "toolu_015z58Lyxh7u3usBwtftsfxB"  // <-- This links to Task
    }]
  }
}
```

## The Fix

### Step 1: Extract and store the real agentId
Added code to extract the `realAgentId` from `toolUseResult` and store it in the agent object:

```javascript
// Extract real agentId from toolUseResult (for mapping to agent files)
if (event.type === 'user' && event.toolUseResult?.agentId && event.message?.content) {
  const content = event.message.content;
  if (Array.isArray(content)) {
    for (const block of content) {
      if (block.type === 'tool_result' && block.tool_use_id) {
        const agent = agentsMap.get(block.tool_use_id);
        if (agent) {
          // Store the real agentId (the hash used in agent-*.jsonl filename)
          agent.realAgentId = event.toolUseResult.agentId;
          console.log('Mapped tool_use_id', block.tool_use_id, 'to real agentId:', event.toolUseResult.agentId);
        }
      }
    }
  }
}
```

### Step 2: Match using realAgentId
Changed the matching logic to search for agents by their `realAgentId`:

```javascript
// Find the agent that has this realAgentId
let matchedAgent = null;
for (const [toolUseId, agent] of agentsMap.entries()) {
  if (agent.realAgentId === agentData.agentId) {
    matchedAgent = agent;
    break;
  }
}

if (matchedAgent) {
  // Add actions and messages to the agent
  matchedAgent.actions = agentData.actions;
  matchedAgent.messages = agentData.messages;
}
```

## Test Results

Running the test on a session with 46 agents:
- **Before fix**: 0 agents matched (0% success rate)
- **After fix**: 45 agents matched (97.8% success rate)

The one unmatched agent likely failed to launch or is still running.

## Files Modified
- `/Users/wijnandtop/Projects/claude_dashboard/server/index.js`
  - Lines 271-286: Added extraction of realAgentId from toolUseResult
  - Lines 308-365: Fixed matching logic to use realAgentId

## Verification
Run the test script to verify the fix:
```bash
node test_full_parsing.js
```

Expected output should show 45+ matched agents with their actions and messages populated.
